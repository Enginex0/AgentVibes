#!/usr/bin/env node

/**
 * AgentVibes - Beautiful ElevenLabs TTS voice commands for Claude Code
 * This file ensures proper execution when run via npx
 */

import { execFileSync } from 'node:child_process';
import path from 'node:path';
import fs from 'node:fs';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Check if we're running in an npx temporary directory
const isNpxExecution = __dirname.includes('_npx') || __dirname.includes('.npm');

// If running via npx, we need to handle things differently
if (isNpxExecution) {
  const arguments_ = process.argv.slice(2);
  const command = arguments_[0] || 'install';

  // For 'install' command, use non-interactive user-level setup by default
  // This provides zero-config installation for the A+ quality fork
  if (command === 'install' || command === 'setup') {
    const userLevelScript = path.join(__dirname, '..', 'scripts', 'install-user-level.sh');

    if (fs.existsSync(userLevelScript)) {
      console.log('\nðŸš€ AgentVibes Zero-Config Installation\n');
      try {
        execFileSync('bash', [userLevelScript], {
          stdio: 'inherit',
          cwd: path.dirname(__dirname),
        });
        process.exit(0);
      } catch (error) {
        console.error('Installation failed. Try interactive mode: npx github:Enginex0/AgentVibes interactive');
        process.exit(error.status || 1);
      }
    }
  }

  // For other commands or if user-level script not found, use interactive installer
  const installerPath = path.join(__dirname, '..', 'src', 'installer.js');

  if (!fs.existsSync(installerPath)) {
    console.error('Error: Could not find installer.js at', installerPath);
    console.error('Current directory:', __dirname);
    process.exit(1);
  }

  try {
    // Security: Use execFileSync with array args to prevent command injection
    // Arguments are passed as array elements, not string interpolation
    execFileSync('node', [installerPath, ...arguments_], {
      stdio: 'inherit',
      cwd: path.dirname(__dirname),
    });
  } catch (error) {
    process.exit(error.status || 1);
  }
} else {
  // Local execution - use installer directly
  import('../src/installer.js');
}
